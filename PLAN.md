# EAV Plugin 5.x Migration & Feature Plan (Source of Truth)

This file is the living, versioned plan for upgrading and evolving the EAV plugin. Do not diverge from this plan without updating this file via PR.

Version: v1.0 (initial consolidated plan)
Owner: ProtechPartsApp Persona
Scope: CakePHP 2.x to 5.x migration (no changes to 2.x), full TypeFactory coverage, interactive setup, DB-agnostic behavior, and UI scaffolding.

High-level principles
- Single family of EAV value tables per install (no PK suffix in table/table-class names).
- Canonical naming:
  - Tables: eav_<type> (e.g., eav_string, eav_json, eav_decimal, eav_fk).
  - PHP Tables: Eav<Model>Table (e.g., EavStringTable, EavJsonTable).
- Field names:
  - Always use entity_id (UUID or INT based on setup selection).
  - Use value (not val) for the attribute’s stored value column.
- Full TypeFactory coverage with sensible defaults; advanced types are opt-in during setup.
- Interactive Setup Command: prompt for connection, PK type, UUID subtype (if uuid), JSON column storage (json/jsonb guarded by driver), output mode (Migrations or raw SQL), jsonEncodeOnWrite, and type selection (defaults + optional).
- DB-agnostic by default; detect default datasource/driver; guard Postgres-only features automatically.
- Configuration persistence: save setup answers to a durable configuration (file and/or DB), and stamp migrations/SQL with the chosen settings.

Feature 1 — Cleanup/Hardening
What’s drifting
- Value tables and classes currently use Av* and pk suffixes (e.g., av_string_uuid/av_string_int) and class resolution uses pk suffixes: see [EavBehavior#avTableClass](file:///home/paul/dev/cakephp/protech_parts/plugins/Eav/src/Model/Behavior/EavBehavior.php#avTableClass) and [EavBehavior#pkSuffix](file:///home/paul/dev/cakephp/protech_parts/plugins/Eav/src/Model/Behavior/EavBehavior.php#pkSuffix).
- JSONB naming drift in class/name composition (Json vs Jsonb): [EavBehavior#tableTypeSegment](file:///home/paul/dev/cakephp/protech_parts/plugins/Eav/src/Model/Behavior/EavBehavior.php#tableTypeSegment).
- Static SQL snapshots under config/Migrations don’t align with canonical direction.

Realignment
- Adopt canonical naming: eav_* tables and Eav* tables classes (no pk suffix).
- Unify entity_id for both PK families; integer PK uses integer type for entity_id.
- Rename val column to value in all schemas, models, and behavior code.
- Remove config/Migrations/*.sql legacy snapshots. All schema is generated by Setup (Migrations or raw SQL).
- Configuration persistence (Setup answers):
  - Preferred: plugins/Eav/config/eav.json (JSON file) with all choices (connection, pkType, uuidSubtype, jsonStorage, jsonEncodeOnWrite, selected types, output mode).
  - Optionally: eav_settings table for multi-node deployments; not required initially.
  - Stamp generated migrations/SQL with a header comment summarizing chosen options.

Acceptance
- Behavior resolves to Eav* classes and eav_* tables.
- Entity ID field is always entity_id; column type matches configured PK family.
- Value column is value across all code and schema.
- No dependency on Av* names or *_uuid/_int tables.

Feature 2 — Data Type Support
Goals
- Support all CakePHP TypeFactory types + custom ‘fk’.
- Default set most apps need; advanced types are opt-in via interactive Setup.
- Single eav_fk table: value type depends on PK family (UUID subtype or BIGINT), but name and schema remain canonical.

Defaults (pre-selected in Setup)
- string, text, integer, smallinteger, tinyinteger, biginteger, decimal, float, boolean, date, datetime, time, json, uuid, binaryuuid, nativeuuid, fk

Optional/Advanced (opt-in during Setup)
- char, binary, enum (string-limited), timestamp, datetimefractional, timestampfractional, timestamptimezone
- geometry, point, linestring, polygon (only if DB/extension supports)
Notes:
- All selected types get a dedicated table Eav* + eav_<type>. For rare/custom types not selected, dynamic tables are supported but documented as possibly less performant.

Acceptance
- Setup scaffolds only the selected set (defaults + optional).
- [EavBehavior#isSupportedType](file:///home/paul/dev/cakephp/protech_parts/plugins/Eav/src/Model/Behavior/EavBehavior.php#isSupportedType) validates using TypeFactory + custom types.

Feature 3 — JSON
Terminology
- JSON Attribute: an attribute whose data_type is json. Stored in eav_json.value (column type json or jsonb).
- JSON Storage (Entity JSON bundle): storing all attributes for a single entity row in one JSON/JSONB column in the entity’s own table. This plugin supports migrating from this bundle to EAV via the JSONB migration command, but EAV tables remain the primary store.

Goals
- Canonical table eav_json regardless of json/jsonb storage.
- Setup prompts: JSON column storage (json or jsonb). JSONB only if Postgres; otherwise default to json.
- Behavior config flag jsonEncodeOnWrite to control write-time encoding for JSON values.
- The JSONB migration command remains for moving data from bundle storage to EAV values.

Changes
- [EavBehavior#tableTypeSegment](file:///home/paul/dev/cakephp/protech_parts/plugins/Eav/src/Model/Behavior/EavBehavior.php#tableTypeSegment): canonicalize json/jsonb to “Json” segment.
- [EavBehavior#castValueForType](file:///home/paul/dev/cakephp/protech_parts/plugins/Eav/src/Model/Behavior/EavBehavior.php#castValueForType): gate JSON encoding behind jsonEncodeOnWrite.
- [EavMigrateJsonbToEavCommand#execute](file:///home/paul/dev/cakephp/protech_parts/plugins/Eav/src/Command/EavMigrateJsonbToEavCommand.php#execute) remains Postgres‑guarded and migrates entity bundle JSONB into EAV values.

Acceptance
- eav_json exists with value column of type json or jsonb as selected.
- Behavior/table resolution unaffected by json/jsonb storage choice.

Feature 4 — Setup Command (Interactive)
Goals
- Interactive prompts with safe driver-based defaults; minimal flags (flags remain for CI).
- Prompt flow:
  1) Connection (default datasource; prompt only if multiple).
  2) Output: Cake Migrations (phinx) or raw SQL.
  3) PK family: uuid or int.
     - If uuid: UUID subtype (Recommended varies by driver)
       - Postgres: nativeuuid (Recommended)
       - MySQL/MariaDB: binaryuuid (Recommended)
       - SQL Server: nativeuuid (Recommended)
       - SQLite: uuid (string) (Recommended)
  4) JSON column storage: json or jsonb (jsonb only on Postgres).
  5) jsonEncodeOnWrite: yes/no (default yes).
  6) Types to scaffold: defaults pre-selected; advanced types selectable.
  7) Confirm and generate.
- Schema specifics for all eav_* tables:
  - id: UUID (row id)
  - entity_table: string(191)
  - entity_id: type depends on PK family (uuid subtype or biginteger)
  - attribute_id: UUID
  - value: column type per eav_<type> (json/jsonb for json)
  - created, modified: DB default CURRENT_TIMESTAMP or addTimestamps (migrations)
  - Unique index: (entity_table, entity_id, attribute_id)
  - FK: attribute_id -> eav_attributes.id (ON DELETE CASCADE)

Migrations and SQL
- If Migrations: use addTimestamps for created/modified (safe even without Table classes).
- If SQL: generate driver-specific SQL with appropriate column types and timestamp defaults.
- Write chosen options as a header comment; persist the full selection in plugins/Eav/config/eav.json.

Acceptance
- Running “bin/cake eav setup” interactively generates a migration or SQL with canonical naming, unified entity_id, and value column.

Feature 5 — EavEntities / EavAttributes / EavAttributeSets
Goals
- Prefix model classes and tables to avoid collisions and keep grouping.
  - Tables: eav_entities, eav_attributes, eav_attribute_sets, eav_attribute_set_attributes
  - Classes: EavEntitiesTable, EavAttributesTable, EavAttributeSetsTable, EavAttributeSetAttributesTable
- Associations:
  - EavAttributes belongsToMany EavAttributeSets through EavAttributeSetAttributes.
  - EavAttributeSets belongsToMany EavAttributes through EavAttributeSetAttributes.
  - EavEntities is a registry of app entities; explicit hasMany to typed values is not modeled (values live in multiple typed tables). The Behavior provides the entity-aware access to values.
- Validation: names required/unique, label lengths, Timestamp behavior across all.

Acceptance
- Bake CRUD for EavAttributes, EavAttributeSets, EavAttributeSetAttributes, and EavEntities.

Feature 6 — Command connection handling
- Auto-detect default datasource; prompt if multiple.
- Keep optional flags for CI but not required for interactive use.
- Maintain Postgres guard for JSONB in [EavMigrateJsonbToEavCommand#execute](file:///home/paul/dev/cakephp/protech_parts/plugins/Eav/src/Command/EavMigrateJsonbToEavCommand.php#execute).

Feature 7 — Behavior consistency and finder
- Update resolution to canonical Eav* classes and eav_* tables (no pk suffixing).
  - [EavBehavior#tableTypeSegment](file:///home/paul/dev/cakephp/protech_parts/plugins/Eav/src/Model/Behavior/EavBehavior.php#tableTypeSegment)
  - [EavBehavior#avTableClass](file:///home/paul/dev/cakephp/protech_parts/plugins/Eav/src/Model/Behavior/EavBehavior.php#avTableClass)
  - [EavBehavior#tableFor](file:///home/paul/dev/cakephp/protech_parts/plugins/Eav/src/Model/Behavior/EavBehavior.php#tableFor)
- Keep unified [EavBehavior#entityIdField](file:///home/paul/dev/cakephp/protech_parts/plugins/Eav/src/Model/Behavior/EavBehavior.php#entityIdField) as entity_id.
- Expand [EavBehavior#findByAttribute](file:///home/paul/dev/cakephp/protech_parts/plugins/Eav/src/Model/Behavior/EavBehavior.php#findByAttribute) using ORM expressions; avoid hard-coded SQL operators outside Postgres specifics. Most consumers will use Cake’s magic finders (e.g., findByName).

Feature 8 — Tests
- Rename fixtures from av_* to eav_*; switch ‘val’ to ‘value’; ensure unified entity_id across fixtures.
- Update tests that assumed AvJsonbUuid class naming (canonicalize to EavJson).
- Add tests for interactive Setup (simulated answers), UUID subtype recommendations, and type selection.
- Add CRUD tests for EavAttributes/EavAttributeSets/EavEntities.
- Add regression coverage for jsonEncodeOnWrite true/false.

Feature 9 — UI scaffolding (bake)
- Bake CRUD for:
  - EavAttributes
  - EavAttributeSets
  - EavAttributeSetAttributes
  - EavEntities
- Basic forms for adding attributes and organizing sets per entity.
- Controller/View route naming can follow plugin defaults; no additional “Eav” prefix in URLs is required beyond the plugin name (Eav).

Feature 10 — Documentation
- Rewrite README with:
  - Overview and capabilities (no 2.x migration notes).
  - Setup walkthrough (interactive prompts) with examples.
  - Supported types: default vs optional; geospatial caveats.
  - UUID subtype recommendations by driver.
  - jsonEncodeOnWrite and hydration expectations.
  - Behavior attachment and mapping examples.
  - AttributeSets and EavEntities usage.
  - Raw SQL vs Migrations options.
- Maintain a CHANGELOG for notable plan/architecture changes.

Deprecations and removals
- Remove config/Migrations/*.sql legacy snapshots (regenerate via Setup).
- Remove Av* classes and av_* fixtures as we migrate; no TableLocator alias needed. Replace all usage with Eav* and eav_*.

Risks and mitigations
- Naming/schema migration: handled via Setup regeneration and clear upgrade notes.
- JSONB availability: guard on Postgres; fall back to JSON elsewhere with a notice.
- Advanced types by driver: warn/skip when unsupported; allow opt-in explicitly.
- Interactive setup in CI: flags remain available for non-interactive runs.

Immediate actionable checklist
- Behavior:
  - Canonicalize to Eav* classes and eav_* tables.
  - Unify entity_id naming and column usage (remove entity_int_id).
  - Rename val -> value across behavior, commands, and tests.
  - Add jsonEncodeOnWrite config and gate JSON encoding.
- Setup:
  - Convert to interactive prompts; add connection detection and driver-based defaults.
  - Generate Migrations or raw SQL; eav_* names; entity_id; value column; timestamp defaults.
  - Persist chosen config to plugins/Eav/config/eav.json; stamp migration/SQL comments.
  - Allow type selection (defaults + optional).
- Commands:
  - Keep Postgres guard in JSONB migrator.
  - Use detected default connection; prompt if multiple; allow flag for CI.
- ORM:
  - Add EavEntities, EavAttributes, EavAttributeSets, EavAttributeSetAttributes with associations and validation.
  - Generate Eav* value tables for selected types, or provide a generator step.
- Tests:
  - Update fixtures, test names, and expectations to eav_* and value.
  - Add interactive setup tests; CRUD tests; jsonEncodeOnWrite tests.
- Docs:
  - Rewrite README; add CHANGELOG entry; cross-link to this PLAN.

Process & governance
- This PLAN.md is the source of truth. Update via PR in branches tied to JIRA tickets (1 feature per branch).
- AGENTS.md should link to this file and summarize status; AGENTS-VSCode.md remains deprecated.
- Per-feature conversation template (include in each chat):
  - Link to this plan: plugins/Eav/PLAN.md
  - JIRA issue key and scope
  - Target files to modify (paths)
  - Desired acceptance criteria and tests to add/update
  - Any special driver assumptions
- After each feature completes, add a short “Conversation Summary” back into this PLAN (or docs/features/FEATURE-<key>.md) with:
  - What changed (files, schema)
  - Commands run
  - Table counts or verifications
  - Follow-ups/TODOs

Driver-based UUID recommendations (used in Setup)
- Postgres: nativeuuid (Recommended)
- MySQL/MariaDB: binaryuuid (Recommended)
- SQL Server: nativeuuid (Recommended)
- SQLite: uuid (string) (Recommended)